<!DOCTYPE html>
<html lang="en">
<head>
    <title>Contact Book</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --danger-color: #dc3545;
            --success-color: #28a745;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1, h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            margin: 30px 0;
            font-size: 2.5rem;
            color: var(--primary-color);
        }
        
        .section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        button.delete {
            background-color: var(--danger-color);
        }
        
        button.delete:hover {
            background-color: #c82333;
        }
        
        button.search {
            background-color: var(--success-color);
        }
        
        button.search:hover {
            background-color: #218838;
        }
        
        ul {
            list-style: none;
            margin-top: 20px;
        }
        
        li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        li:hover {
            background-color: #f9f9f9;
        }
        
        .contact-info {
            flex: 1;
        }
        
        .contact-actions {
            display: flex;
            gap: 10px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--success-color);
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transform: translateX(200%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        @media (max-width: 768px) {
            form {
                flex-direction: column;
            }
            
            input, button {
                width: 100%;
            }
            
            li {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .contact-actions {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>

    <h1>Contact Book</h1>

    <div class="section">
        <h2>Add Contact</h2>
        <form id="addForm" method="POST" action="/add">
            <input type="text" name="name" placeholder="Name" required>
            <input type="text" name="phone" placeholder="Phone" required>
            <input type="email" name="email" placeholder="Email" required>
            <button type="submit">Add Contact</button>
        </form>
    </div>

    <div class="section">
        <h2>All Contacts</h2>
        <div id="searchResults"></div>
        <ul id="contactsList">
            {% for contact in contacts %}
            <li data-name="{{ contact.name }}">
                <div class="contact-info">
                    <strong>{{ contact.name }}</strong> - {{ contact.phone }} - {{ contact.email }}
                </div>
                <div class="contact-actions">
                    <button class="edit" onclick="editContact('{{ contact.name }}')">Edit</button>
                    <button class="delete" onclick="deleteContact('{{ contact.name }}')">Delete</button>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="section">
        <h2>Search Contact</h2>
        <form id="searchForm" method="GET" action="/search">
            <input type="text" name="name" placeholder="Enter name to search" required>
            <button class="search" type="submit">Search</button>
            <button type="button" onclick="clearSearch()">Clear</button>
        </form>
    </div>

    <script>
        // Notification system
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification' + (isError ? ' error' : '');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Form submission with fetch API
        document.getElementById('addForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            try {
                const response = await fetch('/add', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification('Contact added successfully!');
                    // Refresh the contact list
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error('Failed to add contact');
                }
            } catch (error) {
                showNotification('Error adding contact: ' + error.message, true);
                console.error('Error:', error);
            }
        });

        // Search form handling
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const searchQuery = formData.get('name');
            
            try {
                const response = await fetch(`/search?name=${encodeURIComponent(searchQuery)}`);
                if (response.ok) {
                    const results = await response.json();
                    displaySearchResults(results);
                } else {
                    throw new Error('Search failed');
                }
            } catch (error) {
                showNotification('Error searching contacts: ' + error.message, true);
                console.error('Error:', error);
            }
        });

        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            const contactsList = document.getElementById('contactsList');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p>No contacts found matching your search.</p>';
                contactsList.style.display = 'none';
            } else {
                resultsContainer.innerHTML = `<h3>Search Results (${results.length} found)</h3>`;
                contactsList.style.display = 'block';
                
                // Highlight matching contacts
                document.querySelectorAll('#contactsList li').forEach(li => {
                    const contactName = li.getAttribute('data-name');
                    const isMatch = results.some(result => result.name === contactName);
                    li.style.display = isMatch ? 'flex' : 'none';
                });
            }
        }

        function clearSearch() {
            document.getElementById('searchForm').reset();
            document.getElementById('searchResults').innerHTML = '';
            document.querySelectorAll('#contactsList li').forEach(li => {
                li.style.display = 'flex';
            });
        }

        function deleteContact(name) {
            if (confirm(`Are you sure you want to delete ${name}?`)) {
                fetch(`/delete/${encodeURIComponent(name)}`, {
                    method: 'GET'
                })
                .then(response => {
                    if (response.ok) {
                        showNotification('Contact deleted successfully!');
                        // Refresh the contact list
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        throw new Error('Failed to delete contact');
                    }
                })
                .catch(error => {
                    showNotification('Error deleting contact: ' + error.message, true);
                    console.error('Error:', error);
                });
            }
        }

        function editContact(name) {
            const li = document.querySelector(`li[data-name="${name}"]`);
            const contactInfo = li.querySelector('.contact-info').textContent.trim();
            const [currentName, phone, email] = contactInfo.split(' - ');
            
            li.innerHTML = `
                <form class="edit-form" onsubmit="saveContact('${name}'); return false;">
                    <input type="text" name="name" value="${currentName}" required>
                    <input type="text" name="phone" value="${phone}" required>
                    <input type="email" name="email" value="${email}" required>
                    <div class="contact-actions">
                        <button type="submit">Save</button>
                        <button type="button" onclick="cancelEdit('${name}', '${currentName}', '${phone}', '${email}')">Cancel</button>
                    </div>
                </form>
            `;
        }

        function cancelEdit(originalName, name, phone, email) {
            const li = document.querySelector(`li[data-name="${originalName}"]`);
            li.innerHTML = `
                <div class="contact-info">
                    <strong>${name}</strong> - ${phone} - ${email}
                </div>
                <div class="contact-actions">
                    <button class="edit" onclick="editContact('${name}')">Edit</button>
                    <button class="delete" onclick="deleteContact('${name}')">Delete</button>
                </div>
            `;
        }

        async function saveContact(originalName) {
            const form = document.querySelector(`li[data-name="${originalName}"] .edit-form`);
            const formData = new FormData(form);
            const newName = formData.get('name');
            
            try {
                const response = await fetch(`/update/${encodeURIComponent(originalName)}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showNotification('Contact updated successfully!');
                    // Refresh the contact list
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error('Failed to update contact');
                }
            } catch (error) {
                showNotification('Error updating contact: ' + error.message, true);
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>